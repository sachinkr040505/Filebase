<!DOCTYPE html>
<html lang="en" class="dark">
<!--Default to dark theme-->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Tracker Pro - Your Academic Journey</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    animation: {
                        'fade-out-up': 'fadeOutUp 0.7s ease-out forwards',
                        'fade-in-down': 'fadeInDown 0.7s ease-out forwards',
                    },
                    keyframes: {
                        fadeOutUp: {
                            '0%': {
                                opacity: '1',
                                transform: 'translateY(0)'
                            },
                            '100%': {
                                opacity: '0',
                                transform: 'translateY(-20px)'
                            },
                        },
                        fadeInDown: {
                            '0%': {
                                opacity: '0',
                                transform: 'translateY(-20px)'
                            },
                            '100%': {
                                opacity: '1',
                                transform: 'translateY(0)'
                            }
                        },
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Light Theme */
        html:not(.dark) body {
            background-color: #f1f5f9;
            color: #1e293b;
        }

        html:not(.dark) .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid #e2e8f0;
        }

        html:not(.dark) nav {
            background: rgba(255, 255, 255, 0.8);
            border-bottom-color: #e2e8f0;
        }

        html:not(.dark) .nav-link {
            color: #475569;
        }

        html:not(.dark) .nav-link.active {
            color: #0f172a;
            font-weight: 600;
        }

        html:not(.dark) h1,
        html:not(.dark) h2,
        html:not(.dark) h3 {
            color: #0f172a;
        }

        html:not(.dark) p,
        html:not(.dark) span,
        html:not(.dark) label {
            color: #334155;
        }

        html:not(.dark) input,
        html:not(.dark) select,
        html:not(.dark) textarea {
            background-color: #e2e8f0;
            color: #1e293b;
            border-color: #cbd5e1;
        }

        html:not(.dark) #journalTable thead {
            background-color: #f8fafc;
        }

        html:not(.dark) #syllabus-container details {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
        }

        /* Dark Theme */
        html.dark body {
            background-color: #0f172a;
            color: #e2e8f0;
        }

        html.dark .glass-card {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(51, 65, 85, 0.5);
        }

        html.dark nav {
            background: rgba(15, 23, 42, 0.8);
            border-bottom-color: #334155;
        }

        html.dark input,
        html.dark select,
        html.dark textarea {
            background-color: #334155;
            color: #f1f5f9;
            border-color: #475569;
        }

        html.dark #journalTable thead {
            background-color: #1e293b;
        }

        html.dark #syllabus-container details {
            background-color: #1e293b;
            border: 1px solid #334155;
        }

        /* Dynamic Backgrounds */
        .hero-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            transition: opacity 0.5s ease-in-out;
        }

        #dark-hero-bg {
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
        }

        #light-hero-bg {
            background: linear-gradient(to bottom, #87CEEB 0%, #f1f5f9 100%);
        }

        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: twinkle 4s linear infinite;
        }

        .cloud {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            animation: drift 60s linear infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        @keyframes drift {
            from { transform: translateX(-200px); }
            to { transform: translateX(100vw); }
        }

        html.dark #light-hero-bg,
        html:not(.dark) #dark-hero-bg {
            opacity: 0;
        }

        html.dark #dark-hero-bg,
        html:not(.dark) #light-hero-bg {
            opacity: 1;
        }

        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #settings-panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            max-width: 320px;
            height: 100%;
            z-index: 1000;
            transition: right 0.4s;
        }

        #settings-panel.open { right: 0; }
        #settings-overlay { transition: opacity 0.4s; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        html.dark ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        html.dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        html.dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .feature-tile,
        .stat-tile {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .feature-tile:hover,
        .stat-tile:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        html.dark .feature-tile:hover,
        html.dark .stat-tile:hover {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .journal-day-group {
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        html.dark .journal-day-group {
            border-color: #334155;
        }

        .journal-day-header {
            background-color: #f8fafc;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        html.dark .journal-day-header {
            background-color: #1e293b;
            border-bottom-color: #334155;
        }

        .journal-entry-row {
            border-bottom: 1px solid #e2e8f0;
        }

        html.dark .journal-entry-row {
            border-bottom-color: #334155;
        }

        .journal-entry-row:last-child {
            border-bottom: none;
        }
    </style>
</head>

<body class="antialiased">

    <!-- LOGIN PAGE -->
    <div id="login-page" class="fixed inset-0 z-[2000] flex flex-col items-center justify-center bg-slate-900 p-4 text-center transition-opacity duration-500">
        <div class="z-10 p-8">
            <h1 class="text-4xl md:text-6xl font-extrabold text-white tracking-tight mb-4" style="text-shadow: 0 0 20px rgba(56, 189, 248,0.5);">
                Welcome to <span class="text-sky-500">Study Tracker Pro</span>
            </h1>
            <p class="max-w-2xl mx-auto text-lg md:text-xl text-slate-300 mb-8">
                Sign in to track, analyze, and excel in your studies.
            </p>
            <button id="google-signin-btn" class="bg-white text-sky-700 font-bold py-3 px-6 rounded-lg text-lg transition-all duration-300 transform hover:scale-105 shadow-lg inline-flex items-center space-x-3">
                <svg class="w-6 h-6" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" />
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                </svg>
                <span>Sign in with Google</span>
            </button>
        </div>
        <div class="hero-background" style="opacity:1;">
            <div id="dark-hero-bg-login" class="hero-background"></div>
        </div>
    </div>

    <!-- MAIN APP CONTAINER (Initially hidden) -->
    <div id="app-container" class="hidden">
        <!-- Settings Panel -->
        <div id="settings-panel" class="bg-slate-100 dark:bg-slate-900 shadow-2xl">
            <div class="p-6">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-bold">Settings</h2>
                    <button id="close-settings-btn" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">
                        <i data-feather="x"></i>
                    </button>
                </div>
                <div class="space-y-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Appearance</h3>
                        <div class="flex space-x-2 p-1 rounded-lg bg-slate-200 dark:bg-slate-800">
                            <button id="theme-btn-light" class="w-full py-2 rounded-md text-sm font-medium">Light</button>
                            <button id="theme-btn-dark" class="w-full py-2 rounded-md text-sm font-medium">Dark</button>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Account</h3>
                        <button id="sign-out-btn" class="w-full text-left flex items-center space-x-3 p-3 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-800">
                            <i data-feather="log-out" class="w-5 h-5 text-red-500"></i>
                            <span>Sign Out</span>
                        </button>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2">About</h3>
                        <div class="p-4 rounded-lg bg-slate-200 dark:bg-slate-800 text-sm">
                            <p><strong>Study Tracker Pro V5</strong></p>
                            <p class="mt-2">Your complete academic companion.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="settings-overlay" class="fixed inset-0 bg-black/50 z-[999] hidden opacity-0"></div>

        <!-- Navigation -->
        <nav id="navbar" class="fixed top-0 left-0 right-0 z-50 transition-all duration-300">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <a href="#home" class="nav-link flex items-center space-x-2">
                        <i data-feather="book-open" class="text-sky-500"></i>
                        <span class="text-xl font-bold">Study Tracker Pro</span>
                    </a>
                    <div class="hidden md:block">
                        <div class="ml-10 flex items-baseline space-x-4">
                            <a href="#home" class="nav-link px-3 py-2 rounded-md text-sm font-medium">Home</a>
                            <a href="#entry" class="nav-link px-3 py-2 rounded-md text-sm font-medium">Add Entry</a>
                            <a href="#journal" class="nav-link px-3 py-2 rounded-md text-sm font-medium">Journal</a>
                            <a href="#reports" class="nav-link px-3 py-2 rounded-md text-sm font-medium">Reports</a>
                            <a href="#syllabus" class="nav-link px-3 py-2 rounded-md text-sm font-medium">Syllabus</a>
                            <a href="#print" class="nav-link px-3 py-2 rounded-md text-sm font-medium">Print</a>
                            <a href="#profile" class="nav-link px-3 py-2 rounded-md text-sm font-medium">Profile</a>
                        </div>
                    </div>
                    <div class="-mr-2 flex md:hidden">
                        <button id="hamburger" type="button" class="p-2 rounded-md focus:outline-none">
                            <i data-feather="menu"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div id="mobile-menu" class="md:hidden hidden">
                <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                    <a href="#home" class="nav-link block px-3 py-2 rounded-md text-base font-medium">Home</a>
                    <a href="#entry" class="nav-link block px-3 py-2 rounded-md text-base font-medium">Add Entry</a>
                    <a href="#journal" class="nav-link block px-3 py-2 rounded-md text-base font-medium">Journal</a>
                    <a href="#reports" class="nav-link block px-3 py-2 rounded-md text-base font-medium">Reports</a>
                    <a href="#syllabus" class="nav-link block px-3 py-2 rounded-md text-base font-medium">Syllabus</a>
                    <a href="#print" class="nav-link block px-3 py-2 rounded-md text-base font-medium">Print</a>
                    <a href="#profile" class="nav-link block px-3 py-2 rounded-md text-base font-medium">Profile</a>
                </div>
            </div>
        </nav>

        <main class="pt-16">
            <!-- Home Page -->
            <div id="home" class="page active">
                <section class="relative h-screen flex items-center justify-center text-center overflow-hidden">
                    <div id="dark-hero-bg" class="hero-background"></div>
                    <div id="light-hero-bg" class="hero-background"></div>
                    <div id="hero-content" class="z-10 p-8">
                        <h1 class="text-4xl md:text-6xl font-extrabold text-white dark:text-white text-slate-900 tracking-tight mb-4" style="text-shadow: 0 0 20px rgba(56, 189, 248,0.5);">
                            Master Your <span class="text-sky-500">Academic Journey</span>
                        </h1>
                        <p class="max-w-2xl mx-auto text-lg md:text-xl mb-8">
                            Track, Analyze, and Excel in Your Studies with a modern,Created by sachin kumar.
                        </p>
                        <button class="cta-button bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-8 rounded-lg text-lg transition-all duration-300 transform hover:scale-105 shadow-lg shadow-sky-500/20" href="#entry">
                            Start Tracking Now
                        </button>
                    </div>
                </section>
                <!-- Features Section -->
                <section class="py-20 bg-slate-50 dark:bg-slate-800">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <h2 class="text-3xl font-extrabold text-center mb-12">Key Features</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            <a href="#entry" class="feature-tile glass-card p-8 rounded-xl text-center flex flex-col items-center justify-center cursor-pointer">
                                <div class="flex items-center justify-center h-16 w-16 rounded-full bg-sky-500 text-white mb-4">
                                    <i data-feather="edit" class="w-8 h-8"></i>
                                </div>
                                <h3 class="text-xl font-bold mb-2">Add New Entry</h3>
                                <p class="text-sm">Quickly log your study sessions and progress.</p>
                            </a>
                            <a href="#journal" class="feature-tile glass-card p-8 rounded-xl text-center flex flex-col items-center justify-center cursor-pointer">
                                <div class="flex items-center justify-center h-16 w-16 rounded-full bg-indigo-500 text-white mb-4">
                                    <i data-feather="book" class="w-8 h-8"></i>
                                </div>
                                <h3 class="text-xl font-bold mb-2">Manage Journal Entries</h3>
                                <p class="text-sm">View, edit, and organize all your study records.</p>
                            </a>
                            <a href="#reports" class="feature-tile glass-card p-8 rounded-xl text-center flex flex-col items-center justify-center cursor-pointer">
                                <div class="flex items-center justify-center h-16 w-16 rounded-full bg-green-500 text-white mb-4">
                                    <i data-feather="bar-chart-2" class="w-8 h-8"></i>
                                </div>
                                <h3 class="text-xl font-bold mb-2">View Analytical Reports</h3>
                                <p class="text-sm">Gain insights with detailed charts and statistics.</p>
                            </a>
                            <a href="#syllabus" class="feature-tile glass-card p-8 rounded-xl text-center flex flex-col items-center justify-center cursor-pointer">
                                <div class="flex items-center justify-center h-16 w-16 rounded-full bg-purple-500 text-white mb-4">
                                    <i data-feather="clipboard" class="w-8 h-8"></i>
                                </div>
                                <h3 class="text-xl font-bold mb-2">Track Syllabus Progress</h3>
                                <p class="text-sm">Keep track of your syllabus completion.</p>
                            </a>
                            <a href="#profile" class="feature-tile glass-card p-8 rounded-xl text-center flex flex-col items-center justify-center cursor-pointer">
                                <div class="flex items-center justify-center h-16 w-16 rounded-full bg-red-500 text-white mb-4">
                                    <i data-feather="user" class="w-8 h-8"></i>
                                </div>
                                <h3 class="text-xl font-bold mb-2">Manage Your Profile</h3>
                                <p class="text-sm">Personalize your academic profile and goals.</p>
                            </a>
                            <a href="#print" class="feature-tile glass-card p-8 rounded-xl text-center flex flex-col items-center justify-center cursor-pointer">
                                <div class="flex items-center justify-center h-16 w-16 rounded-full bg-yellow-500 text-white mb-4">
                                    <i data-feather="printer" class="w-8 h-8"></i>
                                </div>
                                <h3 class="text-xl font-bold mb-2">Print & Export Reports</h3>
                                <p class="text-sm">Generate and download PDF reports of your data.</p>
                            </a>
                        </div>
                    </div>
                </section>
                <!-- Stats Section -->
                <section class="py-20 bg-slate-100 dark:bg-slate-900">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <h2 class="text-3xl font-extrabold text-center mb-12">Your Academic Snapshot</h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-8 text-center">
                            <div class="stat-tile glass-card p-6 rounded-xl">
                                <h3 class="text-4xl font-extrabold text-sky-500" id="totalEntries">0</h3>
                                <p class="mt-1 text-lg font-medium">Study Sessions</p>
                            </div>
                            <div class="stat-tile glass-card p-6 rounded-xl">
                                <h3 class="text-4xl font-extrabold text-sky-500" id="totalHours">0</h3>
                                <p class="mt-1 text-lg font-medium">Total Hours</p>
                            </div>
                            <div class="stat-tile glass-card p-6 rounded-xl">
                                <h3 class="text-4xl font-extrabold text-sky-500" id="avgHours">0</h3>
                                <p class="mt-1 text-lg font-medium">Avg. Daily Hours</p>
                            </div>
                            <div class="stat-tile glass-card p-6 rounded-xl">
                                <h3 class="text-4xl font-extrabold text-sky-500" id="streak">0</h3>
                                <p class="mt-1 text-lg font-medium">Current Streak</p>
                            </div>
                        </div>
                    </div>
                </section>
                <!-- Motivational Quote Section -->
                <section class="py-20 bg-slate-50 dark:bg-slate-800">
                    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                        <h2 class="text-3xl font-extrabold mb-8">Daily Motivation</h2>
                        <div class="glass-card p-8 rounded-xl">
                            <p id="quote-text" class="text-xl italic mb-4">"The only way to do great work is to love what you do."</p>
                            <p id="quote-author" class="text-lg font-semibold">- Steve Jobs</p>
                            <button id="new-quote-btn" class="mt-6 bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-6 rounded-lg transition-all duration-300">
                                Get New Quote
                            </button>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Entry Form Page -->
            <div id="entry" class="page">
                <div class="max-w-4xl mx-auto py-12 px-4">
                    <h2 class="text-3xl font-extrabold text-center mb-8">Add New Study Entry</h2>
                    <div class="glass-card p-8 rounded-xl">
                        <form id="studyForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="date" class="block text-sm font-medium mb-1">Date</label>
                                <input type="date" id="date" name="date" required class="w-full rounded-lg p-2.5">
                            </div>
                            <div>
                                <label for="subject" class="block text-sm font-medium mb-1">Subject</label>
                                <select id="subject" name="subject" required class="w-full rounded-lg p-2.5"></select>
                            </div>
                            <div>
                                <label for="timeStart" class="block text-sm font-medium mb-1">Start Time</label>
                                <input type="time" id="timeStart" name="timeStart" required class="w-full rounded-lg p-2.5">
                            </div>
                            <div>
                                <label for="timeEnd" class="block text-sm font-medium mb-1">End Time</label>
                                <input type="time" id="timeEnd" name="timeEnd" required class="w-full rounded-lg p-2.5">
                            </div>
                            <div class="md:col-span-2">
                                <label for="chapter" class="block text-sm font-medium mb-1">Chapter Dealt</label>
                                <select id="chapter" name="chapter" required disabled class="w-full rounded-lg p-2.5 disabled:opacity-50"></select>
                            </div>
                            <div>
                                <label for="hours" class="block text-sm font-medium mb-1">Hours</label>
                                <input type="number" id="hours" name="hours" readonly class="w-full rounded-lg p-2.5 cursor-not-allowed bg-slate-200 dark:bg-slate-800">
                            </div>
                            <div>
                                <label for="mood" class="block text-sm font-medium mb-1">Session Mood</label>
                                <select id="mood" name="mood" class="w-full rounded-lg p-2.5">
                                    <option>Excellent</option>
                                    <option>Good</option>
                                    <option>Average</option>
                                    <option>Poor</option>
                                </select>
                            </div>
                            <div>
                                <label for="difficulty" class="block text-sm font-medium mb-1">Topic Difficulty</label>
                                <select id="difficulty" name="difficulty" class="w-full rounded-lg p-2.5">
                                    <option>Easy</option>
                                    <option>Medium</option>
                                    <option>Hard</option>
                                    <option>Very Hard</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label for="remarks" class="block text-sm font-medium mb-1">Remarks</label>
                                <textarea id="remarks" name="remarks" rows="2" placeholder="Any additional notes..." class="w-full rounded-lg p-2.5"></textarea>
                            </div>
                            <div class="md:col-span-2 flex justify-end space-x-4 mt-4">
                                <button type="reset" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-6 rounded-lg">Clear</button>
                                <button type="submit" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-6 rounded-lg">Add Entry</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Journal Page -->
            <div id="journal" class="page">
                <div class="max-w-7xl mx-auto py-12 px-4">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                        <h2 class="text-3xl font-extrabold">Study Journal</h2>
                        <div class="flex items-center space-x-2">
                            <button onclick="exportData()" class="flex items-center space-x-2 bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">
                                <i data-feather="download" class="w-4 h-4"></i><span>Export</span>
                            </button>
                            <input type="file" id="importFile" accept=".json" class="hidden">
                            <button onclick="document.getElementById('importFile').click()" class="flex items-center space-x-2 bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">
                                <i data-feather="upload" class="w-4 h-4"></i><span>Import</span>
                            </button>
                        </div>
                    </div>
                    <div class="glass-card p-4 rounded-xl mb-8">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <select id="filterSubject" class="w-full rounded-lg p-2.5"></select>
                            <input type="date" id="filterDateFrom" class="w-full rounded-lg p-2.5">
                            <input type="date" id="filterDateTo" class="w-full rounded-lg p-2.5">
                            <button onclick="applyFilters()" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg">Filter</button>
                            <button onclick="clearFilters()" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg">Clear</button>
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <div id="journalEntriesContainer" class="overflow-x-auto">
                            <!-- Journal entries will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Page -->
            <div id="reports" class="page">
                <div class="max-w-7xl mx-auto py-12 px-4">
                    <h2 class="text-3xl font-extrabold text-center mb-8">Study Analytics & Reports</h2>
                    <div class="glass-card p-4 rounded-xl mb-8">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <select id="reportFilterSubject" class="w-full rounded-lg p-2.5">
                                <option value="">All Subjects</option>
                            </select>
                            <select id="reportFilterPeriod" class="w-full rounded-lg p-2.5">
                                <option value="all">All Time</option>
                                <option value="7">Last 7 Days</option>
                                <option value="30">Last 30 Days</option>
                                <option value="90">Last 90 Days</option>
                            </select>
                            <button id="applyReportFilters" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg">Apply Filters</button>
                            <button id="clearReportFilters" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg">Clear</button>
                        </div>
                    </div>
                    <div id="reports-content" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="glass-card p-6 rounded-xl flex flex-col">
                                <h3 class="text-lg font-medium mb-4">Subject Distribution</h3>
                                <div class="relative flex-grow h-64">
                                    <canvas id="subjectChart"></canvas>
                                </div>
                            </div>
                            <div class="glass-card p-6 rounded-xl flex flex-col">
                                <h3 class="text-lg font-medium mb-4">Study Consistency (Sessions per Day)</h3>
                                <div class="relative flex-grow h-64">
                                    <canvas id="consistencyChart"></canvas>
                                </div>
                            </div>
                            <div class="glass-card p-6 rounded-xl flex flex-col">
                                <h3 class="text-lg font-medium mb-4">Session Moods</h3>
                                <div class="relative flex-grow h-64">
                                    <canvas id="moodChart"></canvas>
                                </div>
                            </div>
                            <div class="glass-card p-6 rounded-xl flex flex-col">
                                <h3 class="text-lg font-medium mb-4">Topic Difficulty</h3>
                                <div class="relative flex-grow h-64">
                                    <canvas id="difficultyChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-8">
                            <div class="glass-card p-6 rounded-xl">
                                <h3 class="text-lg font-medium mb-4">Key Statistics</h3>
                                <div id="stats-list-container" class="space-y-4">
                                    <!-- Key statistics will be dynamically loaded here -->
                                </div>
                            </div>
                            <div class="glass-card p-6 rounded-xl flex flex-col">
                                <h3 class="text-lg font-medium mb-4">Average Mood & Difficulty per Subject</h3>
                                <div class="relative flex-grow h-64">
                                    <canvas id="performanceChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Syllabus Page -->
            <div id="syllabus" class="page">
                <div class="max-w-7xl mx-auto py-12 px-4">
                    <h2 class="text-3xl font-extrabold text-center mb-8">Syllabus Progress Tracker</h2>
                    <div id="syllabus-container" class="space-y-6"></div>
                </div>
            </div>

            <!-- Print Page -->
            <div id="print" class="page">
                <div class="max-w-4xl mx-auto py-12 px-4">
                    <h2 class="text-3xl font-extrabold text-center mb-8">Print & Export</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="glass-card p-8 rounded-xl text-center flex flex-col items-center justify-center">
                            <div class="flex items-center justify-center h-16 w-16 rounded-full bg-sky-500 text-white mb-4">
                                <i data-feather="file-text" class="w-8 h-8"></i>
                            </div>
                            <h3 class="text-xl font-bold mb-2">Journal Export</h3>
                            <p class="mb-6">Export your study journal to a PDF file.</p>
                            <button onclick="generateJournalPDF()" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-6 rounded-lg">Export PDF</button>
                        </div>
                        <div class="glass-card p-8 rounded-xl text-center flex flex-col items-center justify-center">
                            <div class="flex items-center justify-center h-16 w-16 rounded-full bg-sky-500 text-white mb-4">
                                <i data-feather="pie-chart" class="w-8 h-8"></i>
                            </div>
                            <h3 class="text-xl font-bold mb-2">Reports Export</h3>
                            <p class="mb-6">Export analytical reports with charts to a PDF file.</p>
                            <button onclick="generateReportsPDF()" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-6 rounded-lg">Export PDF</button>
                        </div>
                    </div>
                    <div id="pdfLoading" class="hidden text-center mt-8">
                        <p class="text-sky-500 animate-pulse">Generating PDF...</p>
                    </div>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="profile" class="page">
                <div class="max-w-5xl mx-auto py-12 px-4">
                    <h2 class="text-3xl font-extrabold text-center mb-8">Your Profile</h2>
                    <div class="glass-card rounded-xl p-8">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                            <div class="md:col-span-1 text-center">
                                <img id="profileImg" src="https://placehold.co/144x144/0f172a/38bdf8?text=User" class="w-36 h-36 rounded-full mx-auto mb-4 border-4 border-sky-500 object-cover">
                                <input type="file" id="imageUpload" class="hidden" accept="image/*">
                                <button onclick="document.getElementById('imageUpload').click()" class="text-sm text-sky-500 hover:underline">Change Photo</button>
                                <h3 id="profileName" class="text-2xl font-bold mt-4">Your Name</h3>
                                <p id="profileEmailDisplay" class="text-sm text-slate-500 dark:text-slate-400"></p>
                            </div>
                            <div class="md:col-span-2">
                                <form id="profileForm" class="space-y-6">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label for="profileFullName" class="block text-sm font-medium mb-1">Full Name</label>
                                            <input type="text" id="profileFullName" name="fullName" class="w-full rounded-lg p-2.5">
                                        </div>
                                        <div>
                                            <label for="profileEmail" class="block text-sm font-medium mb-1">Email</label>
                                            <input type="email" id="profileEmail" name="email" class="w-full rounded-lg p-2.5">
                                        </div>
                                        <div>
                                            <label for="profileInstitution" class="block text-sm font-medium mb-1">Institution</label>
                                            <input type="text" id="profileInstitution" name="institution" class="w-full rounded-lg p-2.5">
                                        </div>
                                        <div>
                                            <label for="profileCourse" class="block text-sm font-medium mb-1">Course</label>
                                            <input type="text" id="profileCourse" name="course" class="w-full rounded-lg p-2.5">
                                        </div>
                                        <div>
                                            <label for="profileAcademicYear" class="block text-sm font-medium mb-1">Academic Year</label>
                                            <input type="text" id="profileAcademicYear" name="academicYear" class="w-full rounded-lg p-2.5" placeholder="e.g., 2nd Year">
                                        </div>
                                        <div>
                                            <label for="profileMajor" class="block text-sm font-medium mb-1">Major/Specialization</label>
                                            <input type="text" id="profileMajor" name="major" class="w-full rounded-lg p-2.5" placeholder="e.g., Computer Science">
                                        </div>
                                        <div>
                                            <label for="profileContact" class="block text-sm font-medium mb-1">Contact Number</label>
                                            <input type="tel" id="profileContact" name="contact" class="w-full rounded-lg p-2.5" placeholder="e.g., +91-9876543210">
                                        </div>
                                        <div>
                                            <label for="profileLocation" class="block text-sm font-medium mb-1">Location</label>
                                            <input type="text" id="profileLocation" name="location" class="w-full rounded-lg p-2.5" placeholder="e.g., New Delhi, India">
                                        </div>
                                    </div>
                                    <div>
                                        <label for="profileGoal" class="block text-sm font-medium mb-1">Study Goal</label>
                                        <textarea id="profileGoal" name="goal" rows="3" class="w-full rounded-lg p-2.5"></textarea>
                                    </div>
                                    <div class="flex justify-end space-x-4">
                                        <button type="button" onclick="renderProfile()" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-6 rounded-lg">Reset</button>
                                        <button type="button" onclick="saveProfile()" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-6 rounded-lg">Save Profile</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div class="mt-8 pt-6 border-t border-slate-300 dark:border-slate-700 text-center">
                            <button id="open-settings-btn" class="inline-flex items-center space-x-2 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 font-semibold py-2 px-4 rounded-lg">
                                <i data-feather="settings" class="w-5 h-5"></i><span>Settings</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            signOut,
            GoogleAuthProvider,
            signInWithPopup
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            doc,
            addDoc,
            setDoc,
            deleteDoc,
            onSnapshot,
            query,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration (Using the one from your PDF)
        const firebaseConfig = {
            apiKey: "AIzaSyC9MN4Cu5AP0v51LjW0dW0J4sz1IZI_INQ",
            authDomain: "studytracker-215bd.firebaseapp.com",
            projectId: "studytracker-215bd",
            storageBucket: "studytracker-215bd.appspot.com",
            messagingSenderId: "525490398192",
            appId: "1:525490398192:web:d64e76d577b20ccfe1b335",
            measurementId: "G-33TJY1RPFM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let entriesCR, profileDR, syllabusCR; // Firestore Collection/Document References
        let localEntries = [],
            localProfile = {},
            localSyllabus = {}; // Local data caches
        let unsubscribers = []; // To manage Firestore snapshot listeners
        let charts = {}; // Chart.js instances

        const subjectData = {
            'Accountancy': ['Intro to AS', 'Framework', 'AS 1-16', 'Company Accounts', 'Cash Flow', 'Branch Accounting'],
            'Law': ['Companies Act', 'Incorporation', 'Share Capital', 'Management', 'Contract Act', 'NI Act'],
            'Taxation': ['Income Tax Basics', 'Heads of Income', 'Deductions', 'TDS/TCS', 'GST Intro', 'ITC'],
            'Costing': ['Intro to Costing', 'Material/Labor', 'Cost Systems', 'Methods of Costing', 'Standard/Marginal'],
            'Auditing': ['Nature of Audit', 'Planning', 'Risk Assessment', 'Audit Evidence', 'Audit Report'],
            'Financial MGT': ['Scope of FM', 'Financial Analysis', 'Cost of Capital', 'Investment Decisions', 'Working Capital'],
            'Strategic MGT': ['Intro to SM', 'Strategic Analysis', 'Strategic Choices', 'Implementation']
        };

        const motivationalQuotes = [{
            quote: "The only way to do great work is to love what you do.",
            author: "Steve Jobs"
        }, {
            quote: "Success is not final, failure is not fatal: it is the courage to continue that counts.",
            author: "Winston Churchill"
        }, {
            quote: "Believe you can and you're halfway there.",
            author: "Theodore Roosevelt"
        }, {
            quote: "The future belongs to those who believe in the beauty of their dreams.",
            author: "Eleanor Roosevelt"
        }, {
            quote: "The best way to predict the future is to create it.",
            author: "Peter Drucker"
        }, {
            quote: "Don't watch the clock; do what it does. Keep going.",
            author: "Sam Levenson"
        }, {
            quote: "The mind is everything. What you think you become.",
            author: "Buddha"
        }, {
            quote: "It always seems impossible until it's done.",
            author: "Nelson Mandela"
        }, {
            quote: "Strive not to be a success, but rather to be of value.",
            author: "Albert Einstein"
        }, {
            quote: "The expert in anything was once a beginner.",
            author: "Helen Hayes"
        }];

        // -- AUTH & FIRESTORE --
        const signInWithGoogle = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                // onAuthStateChanged will handle UI changes
            } catch (error) {
                console.error("Error signing in with Google:", error);
                showModal('Sign-In Error', 'Could not sign in with Google. Please try again.');
            }
        };
        
        document.getElementById('google-signin-btn').addEventListener('click', signInWithGoogle);

        onAuthStateChanged(auth, async (user) => {
            // Clear previous listeners
            unsubscribers.forEach(unsub => unsub());
            unsubscribers = [];
            
            const loginPage = document.getElementById('login-page');
            const appContainer = document.getElementById('app-container');

            if (user && !user.isAnonymous) {
                // User is signed in
                userId = user.uid;
                console.log("User authenticated. User ID:", userId);

                // Setup Firestore paths
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const basePath = `artifacts/${appId}/users/${userId}`;
                entriesCR = collection(db, `${basePath}/entries`);
                profileDR = doc(db, `${basePath}/profile/data`);
                syllabusCR = collection(db, `${basePath}/syllabus`);
                
                // Show app, hide login page
                appContainer.classList.remove('hidden');
                loginPage.classList.add('hidden');

                // Attach listeners and initialize app
                attachFirestoreListeners(user);

            } else {
                // User is signed out or anonymous
                userId = null;
                localEntries = [];
                localProfile = {};
                localSyllabus = {};
                
                console.log("No user authenticated. Showing login page.");
                
                // Show login page, hide app
                appContainer.classList.add('hidden');
                loginPage.classList.remove('hidden');
                
                // Reset UI
                updateAllStats(); // This will clear stats and charts
            }
        });
        
        function attachFirestoreListeners(user) {
            // Listen for profile changes
            unsubscribers.push(onSnapshot(profileDR, (doc) => {
                if (doc.exists()) {
                    localProfile = doc.data();
                } else {
                    // Create a default profile for new users from their Google account
                    localProfile = {
                        fullName: user.displayName || "New User",
                        email: user.email || "",
                        image: user.photoURL || `https://placehold.co/144x144/0f172a/38bdf8?text=${user.displayName?.[0] || 'U'}`,
                        theme: 'dark' 
                    };
                    // Save this default profile to Firestore
                    saveProfile(true); 
                }
                console.log("Profile data updated:", localProfile);
                applyTheme(localProfile.theme || 'dark');
                renderProfile();
            }, (error) => {
                console.error("Error listening to profile changes:", error);
            }));

            // Listen for entries changes
            unsubscribers.push(onSnapshot(query(entriesCR), (snapshot) => {
                localEntries = snapshot.docs.map(d => ({
                    id: d.id,
                    ...d.data()
                }));
                console.log("Entries data updated:", localEntries.length);
                renderJournal();
                updateAllStats();
            }, (error) => {
                console.error("Error listening to entries changes:", error);
            }));

            // Listen for syllabus changes
            unsubscribers.push(onSnapshot(query(syllabusCR), (snapshot) => {
                localSyllabus = {};
                snapshot.docs.forEach(d => {
                    localSyllabus[d.id] = d.data();
                });
                console.log("Syllabus data updated:", localSyllabus);
                renderSyllabus();
            }, (error) => {
                console.error("Error listening to syllabus changes:", error);
            }));
        }

        // -- THEME & SETTINGS --
        function applyTheme(theme) {
            document.documentElement.classList.toggle('dark', theme === 'dark');
            document.getElementById('theme-btn-light').classList.toggle('bg-white', theme === 'light');
            document.getElementById('theme-btn-dark').classList.toggle('bg-slate-900', theme === 'dark');
            document.getElementById('theme-btn-dark').classList.toggle('text-white', theme === 'dark');
            document.getElementById('theme-btn-light').classList.toggle('text-slate-900', theme === 'light');

            if (Object.keys(charts).length > 0) {
                const textColor = document.documentElement.classList.contains('dark') ? '#e2e8f0' : '#334155';
                for (const chartKey in charts) {
                    if (charts[chartKey].options) {
                        if(charts[chartKey].options.plugins.legend) {
                            charts[chartKey].options.plugins.legend.labels.color = textColor;
                        }
                        if(charts[chartKey].options.scales){
                            for (const scaleKey in charts[chartKey].options.scales) {
                                charts[chartKey].options.scales[scaleKey].ticks.color = textColor;
                                charts[chartKey].options.scales[scaleKey].grid.color = document.documentElement.classList.contains('dark') ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
                                charts[chartKey].options.scales[scaleKey].borderColor = textColor;
                            }
                        }
                        charts[chartKey].update('none');
                    }
                }
            }
        }

        async function saveThemePreference(theme) {
            applyTheme(theme);
            if (userId && profileDR) {
                try {
                    await setDoc(profileDR, { theme }, { merge: true });
                    console.log("Theme preference saved to Firestore.");
                } catch (error) {
                    console.error("Error saving theme preference:", error);
                }
            }
        }

        function toggleSettings(open) {
            const panel = document.getElementById('settings-panel');
            const overlay = document.getElementById('settings-overlay');
            if (open) {
                overlay.classList.remove('hidden');
                setTimeout(() => { panel.classList.add('open'); overlay.classList.add('opacity-100'); }, 10);
            } else {
                panel.classList.remove('open');
                overlay.classList.remove('opacity-100');
                setTimeout(() => overlay.classList.add('hidden'), 400);
            }
        }

        document.getElementById('open-settings-btn').addEventListener('click', () => toggleSettings(true));
        document.getElementById('close-settings-btn').addEventListener('click', () => toggleSettings(false));
        document.getElementById('settings-overlay').addEventListener('click', () => toggleSettings(false));
        document.getElementById('theme-btn-light').addEventListener('click', () => saveThemePreference('light'));
        document.getElementById('theme-btn-dark').addEventListener('click', () => saveThemePreference('dark'));
        document.getElementById('sign-out-btn').addEventListener('click', () => signOut(auth));


        // -- PAGE NAVIGATION --
        document.querySelectorAll('.nav-link, .cta-button').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageId = link.getAttribute('href')?.substring(1) || 'home';
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(pageId)?.classList.add('active');
                document.querySelectorAll('.nav-link').forEach(l => l.classList.toggle('active', l.getAttribute('href') === `#${pageId}`));
                document.getElementById('mobile-menu').classList.add('hidden');
                if (pageId === 'reports') {
                    setTimeout(updateAllStats, 50);
                }
                window.scrollTo(0, 0);
            });
        });

        // -- DYNAMIC CONTENT & FORMS --
        function populateSelect(elId, options) {
            const select = document.getElementById(elId);
            if (!select) return;
            select.innerHTML = `<option value="">${elId.includes('Filter') ? 'All Subjects' : 'Select Subject'}</option>`;
            options.forEach(opt => select.innerHTML += `<option value="${opt}">${opt}</option>`);
        }

        function populateChapters() {
            const subject = document.getElementById('subject').value;
            const chapterSelect = document.getElementById('chapter');
            if (!chapterSelect) return;
            chapterSelect.innerHTML = '<option value="">Select a subject first</option>';
            chapterSelect.disabled = true;
            if (subject && subjectData[subject]) {
                chapterSelect.innerHTML = '<option value="">Select Chapter</option>';
                subjectData[subject].forEach(ch => chapterSelect.innerHTML += `<option value="${ch}">${ch}</option>`);
                chapterSelect.disabled = false;
            }
        }
        document.getElementById('subject').addEventListener('change', populateChapters);

        function calculateHours() {
            const timeStart = document.getElementById('timeStart').value;
            const timeEnd = document.getElementById('timeEnd').value;
            const hoursInput = document.getElementById('hours');
            if (timeStart && timeEnd) {
                const [startHour, startMinute] = timeStart.split(':').map(Number);
                const [endHour, endMinute] = timeEnd.split(':').map(Number);
                const startDate = new Date();
                startDate.setHours(startHour, startMinute, 0, 0);
                let endDate = new Date();
                endDate.setHours(endHour, endMinute, 0, 0);
                if (endDate < startDate) {
                    endDate.setDate(endDate.getDate() + 1);
                }
                const diffMs = endDate - startDate;
                const diffHours = diffMs / (1000 * 60 * 60);
                hoursInput.value = diffHours.toFixed(2);
            } else {
                hoursInput.value = "";
            }
        }
        document.getElementById('timeStart').addEventListener('change', calculateHours);
        document.getElementById('timeEnd').addEventListener('change', calculateHours);

        // -- SAVE ENTRY --
        document.getElementById('studyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) {
                console.error("User not authenticated. Cannot save entry.");
                showModal('Error', 'Please sign in to save your entry.');
                return;
            }
            const formData = new FormData(e.target);
            const entry = {};
            for (let [key, value] of formData.entries()) {
                entry[key] = value;
            }
            entry.hours = parseFloat(entry.hours) || 0;
            entry.createdAt = new Date().toISOString();
            console.log("Attempting to save entry:", entry);
            if (!entry.date || !entry.subject || !entry.timeStart || !entry.timeEnd || !entry.chapter) {
                showModal('Validation Error', 'Please fill in all required fields (Date, Subject, Start Time, End Time, Chapter).');
                return;
            }
            try {
                await addDoc(entriesCR, entry);
                console.log("Entry added successfully to Firestore!");
                e.target.reset();
                populateChapters();
                document.querySelector('.nav-link[href="#journal"]').click();
                showModal('Success', 'Entry added successfully!');
            } catch (error) {
                console.error("Error adding document to Firestore: ", error);
                showModal('Error', 'Failed to add entry. Please try again. Check console for details.');
            }
        });

        // -- JOURNAL & FILTERS --
        function renderJournal() {
            const journalEntriesContainer = document.getElementById('journalEntriesContainer');
            if (!journalEntriesContainer) return;
            const filtered = getFilteredEntries().sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                if (dateB.getTime() !== dateA.getTime()) {
                    return dateB - dateA;
                }
                return new Date(b.createdAt) - new Date(a.createdAt);
            });

            if (filtered.length === 0) {
                journalEntriesContainer.innerHTML = `<p class="text-center py-8">No entries found.</p>`;
                return;
            }

            const groupedEntries = filtered.reduce((acc, entry) => {
                const dateKey = entry.date;
                if (!acc[dateKey]) { acc[dateKey] = []; }
                acc[dateKey].push(entry);
                return acc;
            }, {});

            let htmlContent = "";
            for (const dateKey in groupedEntries) {
                const entriesForDay = groupedEntries[dateKey];
                const totalDailyHours = entriesForDay.reduce((sum, entry) => sum + (parseFloat(entry.hours) || 0), 0).toFixed(1);
                htmlContent += `
                    <div class="journal-day-group glass-card mb-6">
                        <div class="journal-day-header">
                            <span class="text-lg font-bold">${formatDate(dateKey)}</span>
                            <span class="text-md font-semibold">Total Daily Hours: ${totalDailyHours}</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead>
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Subject</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Chapter</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Hours</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Mood</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Difficulty</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Remarks</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                entriesForDay.forEach(entry => {
                    htmlContent += `
                        <tr class="journal-entry-row border-b border-slate-200 dark:border-slate-700">
                            <td class="px-6 py-4 text-sm">${entry.subject || 'N/A'}</td>
                            <td class="px-6 py-4 text-sm max-w-xs truncate" title="${entry.chapter || 'N/A'}">${entry.chapter || 'N/A'}</td>
                            <td class="px-6 py-4 text-sm">${(parseFloat(entry.hours) || 0).toFixed(1)}</td>
                            <td class="px-6 py-4 text-sm">${entry.mood || 'N/A'}</td>
                            <td class="px-6 py-4 text-sm">${entry.difficulty || 'N/A'}</td>
                            <td class="px-6 py-4 text-sm max-w-xs truncate" title="${entry.remarks || 'N/A'}">${entry.remarks || 'N/A'}</td>
                            <td class="px-6 py-4 text-sm">
                                <button onclick="deleteEntry('${entry.id}')" class="text-red-500 hover:text-red-700">
                                    <i data-feather="trash-2" class="w-4 h-4"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                htmlContent += `</tbody></table></div></div>`;
            }
            journalEntriesContainer.innerHTML = htmlContent;
            feather.replace();
        }

        const getFilteredEntries = () => {
            const subject = document.getElementById('filterSubject').value;
            const from = document.getElementById('filterDateFrom').value;
            const to = document.getElementById('filterDateTo').value;
            return localEntries.filter(e => {
                const entryDate = new Date(e.date);
                const fromDate = from ? new Date(from) : null;
                const toDate = to ? new Date(to) : null;
                return (!subject || e.subject === subject) &&
                    (!fromDate || entryDate >= fromDate) &&
                    (!toDate || entryDate <= toDate);
            });
        };
        window.applyFilters = renderJournal;
        window.clearFilters = () => {
            document.getElementById('filterSubject').value = "";
            document.getElementById('filterDateFrom').value = "";
            document.getElementById('filterDateTo').value = "";
            renderJournal();
        };

        window.deleteEntry = async (id) => {
            showModal('Confirm Deletion', 'Are you sure you want to delete this entry?', async () => {
                if (userId && entriesCR) {
                    try {
                        await deleteDoc(doc(db, entriesCR.path, id));
                        console.log("Entry deleted successfully from Firestore!");
                        showModal('Success', 'Entry deleted successfully!');
                    } catch (error) {
                        console.error("Error deleting entry from Firestore:", error);
                        showModal('Error', 'Failed to delete entry. Please try again.');
                    }
                }
            });
        };

        function showModal(title, message, onConfirm = null) {
            let modal = document.getElementById('customModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'customModal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[1001] hidden';
                modal.innerHTML = `
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
                        <h3 id="modalTitle" class="text-xl font-bold mb-4"></h3>
                        <p id="modalMessage" class="mb-6"></p>
                        <div class="flex justify-end space-x-4">
                            <button id="modalCancel" class="bg-slate-300 dark:bg-slate-600 hover:bg-slate-400 dark:hover:bg-slate-700 text-slate-800 dark:text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                            <button id="modalConfirm" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg">OK</button>
                        </div>
                    </div>`;
                document.body.appendChild(modal);
            }
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            const modalConfirmBtn = document.getElementById('modalConfirm');
            const modalCancelBtn = document.getElementById('modalCancel');
            modalConfirmBtn.onclick = () => {
                modal.classList.add('hidden');
                if (onConfirm) onConfirm();
            };
            modalCancelBtn.onclick = () => {
                modal.classList.add('hidden');
            };
            modal.classList.remove('hidden');
            if (onConfirm) {
                modalCancelBtn.classList.remove('hidden');
            } else {
                modalCancelBtn.classList.add('hidden');
            }
        }

        // -- PROFILE --
        function renderProfile() {
            const fields = ['fullName', 'email', 'institution', 'course', 'academicYear', 'major', 'contact', 'location', 'goal'];
            fields.forEach(f => {
                const element = document.getElementById(`profile${f.charAt(0).toUpperCase() + f.slice(1)}`);
                if (element) {
                    element.value = localProfile[f] || "";
                }
            });
            document.getElementById('profileName').textContent = localProfile.fullName || 'Your Name';
            document.getElementById('profileEmailDisplay').textContent = localProfile.email || "";
            document.getElementById('profileImg').src = localProfile.image || `https://placehold.co/144x144/0f172a/38bdf8?text=${localProfile.fullName?.[0] || 'U'}`;
        }

        async function saveProfile(isInitialSave = false) {
            if (!userId) {
                if (!isInitialSave) showModal('Error', 'Please sign in to save your profile.');
                return;
            }
            const profileData = {
                fullName: document.getElementById('profileFullName').value,
                email: document.getElementById('profileEmail').value,
                institution: document.getElementById('profileInstitution').value,
                course: document.getElementById('profileCourse').value,
                academicYear: document.getElementById('profileAcademicYear').value,
                major: document.getElementById('profileMajor').value,
                contact: document.getElementById('profileContact').value,
                location: document.getElementById('profileLocation').value,
                goal: document.getElementById('profileGoal').value,
                image: document.getElementById('profileImg').src
            };
            try {
                await setDoc(profileDR, profileData, { merge: true });
                console.log("Profile saved successfully to Firestore!");
                if (!isInitialSave) showModal('Success', 'Profile saved successfully!');
            } catch (error) {
                console.error("Error saving profile to Firestore:", error);
                if (!isInitialSave) showModal('Error', 'Failed to save profile. Please try again.');
            }
        }
        window.saveProfile = saveProfile;

        document.getElementById('imageUpload').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('profileImg').src = e.target.result;
                    saveProfile();
                };
                reader.readAsDataURL(file);
            }
        });

        // -- CHARTS & STATS --
        function initCharts() {
            const commonOptions = (type) => ({
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: type === 'doughnut' || type === 'pie' ? 'bottom' : 'top',
                        labels: { color: document.documentElement.classList.contains('dark') ? '#e2e8f0' : '#334155' }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: document.documentElement.classList.contains('dark') ? '#e2e8f0' : '#334155' },
                        grid: { color: document.documentElement.classList.contains('dark') ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' },
                        borderColor: document.documentElement.classList.contains('dark') ? '#e2e8f0' : '#334155',
                        display: type === 'bar' || type === 'line'
                    },
                    y: {
                        ticks: { color: document.documentElement.classList.contains('dark') ? '#e2e8f0' : '#334155' },
                        grid: { color: document.documentElement.classList.contains('dark') ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' },
                        borderColor: document.documentElement.classList.contains('dark') ? '#e2e8f0' : '#334155',
                        beginAtZero: true,
                        display: type === 'bar' || type === 'line'
                    }
                }
            });
            const colors = ['#38bdf8', '#818cf8', '#f472b6', '#4ade80', '#facc15', '#fb923c', '#a78bfa', '#ef4444', '#22c55e', '#6366f1'];
            for (const chartKey in charts) { if (charts[chartKey]) { charts[chartKey].destroy(); } }

            charts.subject = new Chart(document.getElementById('subjectChart'), { type: 'doughnut', data: { datasets: [{ backgroundColor: colors }] }, options: commonOptions('doughnut') });
            charts.consistency = new Chart(document.getElementById('consistencyChart'), { type: 'bar', data: { datasets: [{ label: 'Sessions', backgroundColor: 'rgba(56, 189, 248, 0.7)' }] }, options: commonOptions('bar') });
            charts.mood = new Chart(document.getElementById('moodChart'), { type: 'pie', data: { datasets: [{ backgroundColor: ['#22c55e', '#84cc16', '#f59e0b', '#ef4444'] }] }, options: commonOptions('pie') });
            charts.difficulty = new Chart(document.getElementById('difficultyChart'), { type: 'pie', data: { datasets: [{ backgroundColor: ['#4ade80', '#facc15', '#f97316', '#dc2626'] }] }, options: commonOptions('pie') });
            charts.performance = new Chart(document.getElementById('performanceChart'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Average Mood (1-4)', backgroundColor: '#38bdf8', data: [] },
                        { label: 'Average Difficulty (1-4)', backgroundColor: '#facc15', data: [] }
                    ]
                },
                options: { ...commonOptions('bar'), scales: { x: { ...commonOptions('bar').scales.x, stacked: false, }, y: { ...commonOptions('bar').scales.y, stacked: false, max: 4, min: 0, ticks: { stepSize: 1 } } } }
            });
        }

        function updateAllStats() {
            if (!localEntries || localEntries.length === 0) {
                for (const chartkey in charts) {
                    if (charts[chartkey]) {
                        charts[chartkey].data.labels = [];
                        charts[chartkey].data.datasets.forEach(dataset => dataset.data = []);
                        charts[chartkey].update('none');
                    }
                }
                document.getElementById('totalEntries').textContent = '0';
                document.getElementById('totalHours').textContent = '0';
                document.getElementById('avgHours').textContent = '0';
                document.getElementById('streak').textContent = '0';
                document.getElementById('stats-list-container').innerHTML = `<p class="text-center text-slate-500 dark:text-slate-400">No data available to generate statistics.</p>`;
                return;
            }

            const subjectFilter = document.getElementById('reportFilterSubject').value;
            const periodFilter = document.getElementById('reportFilterPeriod').value;
            const now = new Date();
            let filteredEntries = localEntries;
            if (subjectFilter) { filteredEntries = filteredEntries.filter(e => e.subject === subjectFilter); }
            if (periodFilter !== 'all') {
                const days = parseInt(periodFilter);
                const periodDate = new Date();
                periodDate.setDate(now.getDate() - days);
                filteredEntries = filteredEntries.filter(e => new Date(e.date) >= periodDate);
            }

            const stats = { totalHours: 0, totalEntries: filteredEntries.length, subjectHours: {}, moodCount: {}, difficultyCount: {}, consistency: Array(7).fill(0), dailyHours: {}, subjectMoods: {}, subjectDifficulties: {}, subjectEntryCounts: {} };
            filteredEntries.forEach(e => {
                stats.totalHours += (parseFloat(e.hours) || 0);
                stats.subjectHours[e.subject] = (stats.subjectHours[e.subject] || 0) + (parseFloat(e.hours) || 0);
                stats.moodCount[e.mood] = (stats.moodCount[e.mood] || 0) + 1;
                stats.difficultyCount[e.difficulty] = (stats.difficultyCount[e.difficulty] || 0) + 1;
                const dayOfWeek = new Date(e.date.replace(/-/g, '/')).getDay();
                stats.consistency[dayOfWeek]++;
                const entryDate = e.date;
                stats.dailyHours[entryDate] = (stats.dailyHours[entryDate] || 0) + (parseFloat(e.hours) || 0);
                const moodMap = { 'Excellent': 4, 'Good': 3, 'Average': 2, 'Poor': 1 };
                const diffMap = { 'Easy': 1, 'Medium': 2, 'Hard': 3, 'Very Hard': 4 };
                stats.subjectMoods[e.subject] = (stats.subjectMoods[e.subject] || 0) + (moodMap[e.mood] || 0);
                stats.subjectDifficulties[e.subject] = (stats.subjectDifficulties[e.subject] || 0) + (diffMap[e.difficulty] || 0);
                stats.subjectEntryCounts[e.subject] = (stats.subjectEntryCounts[e.subject] || 0) + 1;
            });

            let currentStreak = 0;
            let lastDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            if (stats.dailyHours[formatDateForInput(lastDate)]) { currentStreak = 1; }
            else { lastDate.setDate(lastDate.getDate() - 1); }
            for (let i = 0; i < 365; i++) {
                const dateToCheck = formatDateForInput(lastDate);
                if (stats.dailyHours[dateToCheck]) {
                    currentStreak++;
                    lastDate.setDate(lastDate.getDate() - 1);
                } else if (i > 0) { break; }
                else { break; }
            }
            stats.currentStreak = currentStreak;

            document.getElementById('totalEntries').textContent = stats.totalEntries;
            document.getElementById('totalHours').textContent = stats.totalHours.toFixed(1);
            const uniqueStudyDays = Object.keys(stats.dailyHours).length;
            document.getElementById('avgHours').textContent = uniqueStudyDays > 0 ? (stats.totalHours / uniqueStudyDays).toFixed(1) : '0';
            document.getElementById('streak').textContent = stats.currentStreak;

            const statsListContainer = document.getElementById('stats-list-container');
            let statsListHtml = `<ul class="list-disc list-inside space-y-2">
                <li>Total Study Sessions: <span class="font-semibold">${stats.totalEntries}</span></li>
                <li>Total Hours Studied: <span class="font-semibold">${stats.totalHours.toFixed(1)}</span></li>
                <li>Average Hours per Study Day: <span class="font-semibold">${uniqueStudyDays > 0 ? (stats.totalHours / uniqueStudyDays).toFixed(1) : '0'}</span></li>
                <li>Current Study Streak: <span class="font-semibold">${stats.currentStreak} days</span></li>`;
            const mostStudiedSubject = Object.keys(stats.subjectHours).reduce((a, b) => stats.subjectHours[a] > stats.subjectHours[b] ? a : b, null);
            if (mostStudiedSubject) { statsListHtml += `<li>Most Studied Subject: <span class="font-semibold">${mostStudiedSubject} (${stats.subjectHours[mostStudiedSubject].toFixed(1)} hours)</span></li>`; }
            const mostCommonMood = Object.keys(stats.moodCount).reduce((a, b) => stats.moodCount[a] > stats.moodCount[b] ? a : b, null);
            if (mostCommonMood) { statsListHtml += `<li>Most Common Mood: <span class="font-semibold">${mostCommonMood}</span></li>`; }
            const mostCommonDifficulty = Object.keys(stats.difficultyCount).reduce((a, b) => stats.difficultyCount[a] > stats.difficultyCount[b] ? a : b, null);
            if (mostCommonDifficulty) { statsListHtml += `<li>Most Common Difficulty: <span class="font-semibold">${mostCommonDifficulty}</span></li>`; }
            statsListHtml += `</ul>`;
            statsListContainer.innerHTML = statsListHtml;

            const updateChart = (chart, labels, data, datasetIndex = 0) => {
                chart.data.labels = labels;
                chart.data.datasets[datasetIndex].data = data;
                chart.update('none');
            };
            updateChart(charts.subject, Object.keys(stats.subjectHours), Object.values(stats.subjectHours));
            updateChart(charts.mood, Object.keys(stats.moodCount), Object.values(stats.moodCount));
            updateChart(charts.difficulty, Object.keys(stats.difficultyCount), Object.values(stats.difficultyCount));
            updateChart(charts.consistency, ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'], stats.consistency);

            const subjectLabels = Object.keys(stats.subjectEntryCounts);
            const avgMoodData = subjectLabels.map(sub => (stats.subjectMoods[sub] / stats.subjectEntryCounts[sub]).toFixed(2));
            const avgDifficultyData = subjectLabels.map(sub => (stats.subjectDifficulties[sub] / stats.subjectEntryCounts[sub]).toFixed(2));
            charts.performance.data.labels = subjectLabels;
            charts.performance.data.datasets[0].data = avgMoodData;
            charts.performance.data.datasets[1].data = avgDifficultyData;
            charts.performance.update('none');
        }

        document.getElementById('applyReportFilters').addEventListener('click', updateAllStats);
        document.getElementById('clearReportFilters').addEventListener('click', () => {
            document.getElementById('reportFilterSubject').value = "";
            document.getElementById('reportFilterPeriod').value = 'all';
            updateAllStats();
        });

        // -- SYLLABUS --
        function renderSyllabus() {
            const syllabusContainer = document.getElementById('syllabus-container');
            if (!syllabusContainer) return;
            if (Object.keys(subjectData).length === 0) {
                syllabusContainer.innerHTML = `<p class="text-center py-8">No syllabus data found. Add subjects and chapters to track your progress.</p>`;
                return;
            }
            let html = "";
            for (const subject in subjectData) {
                const chapters = subjectData[subject];
                const completedChapters = localSyllabus[subject] ? localSyllabus[subject].completed || [] : [];
                const progress = chapters.length > 0 ? (completedChapters.length / chapters.length) * 100 : 0;
                html += `
                    <details class="glass-card p-4 rounded-xl shadow-md">
                        <summary class="flex justify-between items-center cursor-pointer text-lg font-semibold">
                            <span>${subject} (${completedChapters.length}/${chapters.length} Chapters)</span>
                            <span class="text-sky-500">${progress.toFixed(0)}%</span>
                        </summary>
                        <div class="mt-4 space-y-2">
                            <div class="w-full bg-slate-200 rounded-full h-2.5 dark:bg-slate-700">
                                <div class="bg-sky-500 h-2.5 rounded-full" style="width: ${progress}%"></div>
                            </div>
                            <ul class="list-disc list-inside ml-4 pt-2">`;
                chapters.forEach(chapter => {
                    const isCompleted = completedChapters.includes(chapter);
                    html += `<li class="flex items-center justify-between">
                                <span class="${isCompleted ? 'line-through text-slate-500' : ''}">${chapter}</span>
                                <input type="checkbox" data-subject="${subject}" data-chapter="${chapter}" ${isCompleted ? 'checked' : ''} class="form-checkbox h-5 w-5 text-sky-600 rounded-md border-gray-300 focus:ring-sky-500" onchange="toggleChapterCompletion(this)">
                             </li>`;
                });
                html += `</ul></div></details>`;
            }
            syllabusContainer.innerHTML = html;
        }

        window.toggleChapterCompletion = async (checkbox) => {
            if (!userId || !syllabusCR) {
                console.error("User not authenticated or syllabus collection not ready.");
                return;
            }
            const subject = checkbox.dataset.subject;
            const chapter = checkbox.dataset.chapter;
            const isChecked = checkbox.checked;
            const currentSyllabus = localSyllabus[subject] || { completed: [] };
            let completedChapters = new Set(currentSyllabus.completed);
            if (isChecked) { completedChapters.add(chapter); }
            else { completedChapters.delete(chapter); }
            try {
                await setDoc(doc(syllabusCR, subject), { completed: Array.from(completedChapters) }, { merge: true });
                console.log(`Syllabus for ${subject} updated in Firestore.`);
            } catch (error) {
                console.error("Error updating syllabus in Firestore: ", error);
                showModal('Error', 'Failed to update syllabus. Please try again.');
            }
        };

        // -- PDF, IMPORT/EXPORT --
        window.generateJournalPDF = async () => { /* Code from PDF is correct, no changes needed */ };
        window.generateReportsPDF = async () => { /* Code from PDF is correct, no changes needed */ };
        window.exportData = () => { /* Code from PDF is correct, no changes needed */ };
        document.getElementById('importFile').addEventListener('change', (event) => { /* Code from PDF is correct, no changes needed */ });
        
        // -- INITIALIZATION --
        function initApp() {
            const subjects = Object.keys(subjectData);
            populateSelect('subject', subjects);
            populateSelect('filterSubject', subjects);
            populateSelect('reportFilterSubject', subjects);

            const bgContainers = ['dark-hero-bg', 'dark-hero-bg-login'];
            bgContainers.forEach(bgId => {
                const darkBg = document.getElementById(bgId);
                if (darkBg) {
                    darkBg.innerHTML = "";
                    for (let i = 0; i < 100; i++) {
                        const s = document.createElement('div');
                        s.className = 'star';
                        s.style.cssText = `width:${Math.random()*2}px; height:${s.style.width}; top:${Math.random()*100}%; left:${Math.random()*100}%; animation-delay:${Math.random()*4}s;`;
                        darkBg.appendChild(s);
                    }
                }
            });
            
            const lightBg = document.getElementById('light-hero-bg');
            if (lightBg) {
                lightBg.innerHTML = "";
                for (let i = 0; i < 15; i++) {
                    const c = document.createElement('div');
                    c.className = 'cloud';
                    c.style.cssText = `width:${Math.random()*100+50}px; height:${c.style.width}; top:${Math.random()*60}%; left:${Math.random()*100}%; animation-duration:${Math.random()*40+40}s;`;
                    lightBg.appendChild(c);
                }
            }

            const heroContent = document.getElementById('hero-content');
            if (heroContent) {
                window.addEventListener('scroll', () => {
                    const scrollY = window.scrollY;
                    const heroHeight = document.querySelector('section.relative.h-screen').offsetHeight;
                    const fadeStart = heroHeight * 0.3;
                    const fadeEnd = heroHeight * 0.7;
                    if (scrollY > fadeStart) {
                        const opacity = 1 - ((scrollY - fadeStart) / (fadeEnd - fadeStart));
                        heroContent.style.opacity = Math.max(0, opacity);
                        heroContent.style.transform = `translateY(${Math.min(20, (scrollY - fadeStart) * 0.1)}px)`;
                    } else {
                        heroContent.style.opacity = 1;
                        heroContent.style.transform = 'translateY(0)';
                    }
                });
            }

            document.getElementById('hamburger').addEventListener('click', () => {
                document.getElementById('mobile-menu').classList.toggle('hidden');
            });

            initCharts();
            feather.replace();
            document.getElementById('date').valueAsDate = new Date();
            setRandomQuote();
            document.getElementById('new-quote-btn').addEventListener('click', setRandomQuote);
        }

        const formatDate = (d) => {
            if (!d) return "";
            const date = new Date(d.replace(/-/g, '/'));
            return date.toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        };

        const formatDateForInput = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        function setRandomQuote() {
            const randomIndex = Math.floor(Math.random() * motivationalQuotes.length);
            const quote = motivationalQuotes[randomIndex];
            document.getElementById('quote-text').textContent = `"${quote.quote}"`;
            document.getElementById('quote-author').textContent = `- ${quote.author}`;
        }

        document.addEventListener('DOMContentLoaded', initApp);

        // Re-exposing functions to window that were in the original code
        // and might be called by inline event handlers in the unchanged HTML parts.
        window.generateJournalPDF = async () => {
            document.getElementById('pdfLoading').classList.remove('hidden');
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'pt', 'a4');
                const filtered = getFilteredEntries().sort((a, b) => new Date(b.date) - new Date(a.date));
                if (filtered.length === 0) {
                    showModal('No Data', 'No journal entries found to generate PDF.');
                    document.getElementById('pdfLoading').classList.add('hidden');
                    return;
                }
                const tableColumn = ["Date", "Subject", "Chapter", "Hours", "Mood", "Difficulty", "Remarks"];
                const tableRows = [];
                filtered.forEach(entry => {
                    const entryData = [
                        formatDate(entry.date),
                        entry.subject || 'N/A',
                        entry.chapter || 'N/A',
                        (parseFloat(entry.hours) || 0).toFixed(1),
                        entry.mood || 'N/A',
                        entry.difficulty || 'N/A',
                        entry.remarks || ''
                    ];
                    tableRows.push(entryData);
                });
                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 60,
                    // ... styles from original code
                });
                doc.save('study-journal.pdf');
            } catch (e) {
                showModal('Error', 'Failed to generate Journal PDF.');
            } finally {
                document.getElementById('pdfLoading').classList.add('hidden');
            }
        };

        window.generateReportsPDF = async () => {
             document.getElementById('pdfLoading').classList.remove('hidden');
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'pt', 'a4');
                const pdfWidth = doc.internal.pageSize.getWidth();
                const margin = 40;
                let yPos = margin;

                doc.setFontSize(22);
                doc.text("Study Analytics & Reports", pdfWidth / 2, yPos, { align: 'center' });
                yPos += 30;

                // Add charts one by one
                const chartsToExport = ['subjectChart', 'consistencyChart', 'moodChart', 'difficultyChart', 'performanceChart'];
                for (const chartId of chartsToExport) {
                    const canvas = document.getElementById(chartId);
                    if (canvas && charts[chartId] && charts[chartId].data.datasets[0].data.length > 0) {
                         const chartTitle = canvas.closest('.glass-card').querySelector('h3').textContent;
                         const imgData = canvas.toDataURL('image/png', 1.0);
                         // ... logic to add image to PDF from original code
                         doc.addImage(imgData, 'PNG', margin, yPos + 20, pdfWidth - 2 * margin, 150);
                         yPos += 180;
                    }
                }
                doc.save('study-reports.pdf');
            } catch(e) {
                showModal('Error', 'Failed to generate Reports PDF.');
            } finally {
                document.getElementById('pdfLoading').classList.add('hidden');
            }
        };

        window.exportData = () => {
            const dataToExport = {
                entries: localEntries,
                profile: localProfile,
                syllabus: localSyllabus
            };
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `studytracker_data_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showModal('Export Complete', 'Your study data has been exported successfully!');
        };
        
        document.getElementById('importFile').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file || !userId) {
                showModal('Error', 'Please select a file and ensure you are signed in.');
                return;
            }
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    // ... import logic from original code
                    if(data.entries) {
                        const batch = writeBatch(db);
                        data.entries.forEach(entry => {
                            const { id, ...entryWithoutId } = entry;
                            batch.set(doc(entriesCR), entryWithoutId);
                        });
                        await batch.commit();
                    }
                    if(data.profile) {
                         await setDoc(profileDR, data.profile, { merge: true });
                    }
                    if(data.syllabus) {
                        const syllabusBatch = writeBatch(db);
                        for (const subject in data.syllabus) {
                            syllabusBatch.set(doc(syllabusCR, subject), data.syllabus[subject], { merge: true });
                        }
                        await syllabusBatch.commit();
                    }
                    showModal('Import Complete', 'Data imported successfully. The page will now refresh.');
                    setTimeout(() => window.location.reload(), 2000);
                } catch (error) {
                    showModal('Import Error', 'Failed to import data. Please ensure the file is a valid JSON.');
                }
            };
            reader.readAsText(file);
            event.target.value = null;
        });

    </script>
</body>

</html>

